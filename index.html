<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUSIC DNA - ç©¶æ¥µã®éŸ³æ¥½å±æ€§è¨ºæ–­</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --bg: #050505; --card-inner: #121212; --accent-l: #6366f1; --accent-r: #ec4899; --text: #ffffff; --text-dim: #a1a1aa; }
        body { font-family: "Inter", "Hiragino Kaku Gothic ProN", sans-serif; background-color: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 60px 0 40px; }
        header h1 { font-size: 2rem; letter-spacing: 6px; font-weight: 900; margin: 0; background: linear-gradient(90deg, var(--accent-l), var(--accent-r)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #loading-status { text-align: center; font-size: 0.7rem; color: #4ade80; margin-top: 10px; height: 1em; }

        .question-wrapper { display: flex; flex-direction: column; gap: 20px; margin-bottom: 60px; }
        .q-container { background: var(--card-inner); border-radius: 20px; padding: 25px; border: 1px solid #27272a; }
        .q-header { font-size: 0.7rem; color: var(--text-dim); margin-bottom: 15px; display: block; text-align: center; letter-spacing: 2px; }
        .choice-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .choice-btn { background: #18181b; border: 2px solid #27272a; color: white; padding: 15px 10px; border-radius: 12px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; min-height: 80px; }
        .choice-btn.active { border-color: var(--accent-l); background: rgba(99, 102, 241, 0.1); }

        .analyze-btn { width: 100%; max-width: 300px; background: white; color: black; border: none; padding: 20px; border-radius: 50px; font-size: 1rem; font-weight: 900; cursor: pointer; display: block; margin: 0 auto 100px; }
        .analyze-btn:disabled { background: #27272a; color: #52525b; }

        #result-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px 10px; box-sizing: border-box;}
        #capture-area { background: #fff; color: #000; border-radius: 32px; overflow: hidden; width: 100%; max-width: 400px; margin: 0 auto; }
        .card-top { background: #000; padding: 30px 20px; text-align: center; color: white; }
        .card-content { padding: 30px 25px; text-align: center; }
        .res-title { font-size: 1.4rem; font-weight: 900; color: #000; margin-bottom: 10px; line-height: 1.2; }
        .res-desc { font-size: 0.85rem; color: #4b5563; margin-bottom: 30px; }

        /* ãƒãƒƒãƒãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ã®èª¿æ•´ */
        .match-section-title { font-size: 0.7rem; font-weight: 800; color: #9ca3af; letter-spacing: 1px; margin-bottom: 8px; }
        .best-artist-display { margin-bottom: 25px; }
        .best-name { font-size: 1.6rem; font-weight: 900; color: #000; display: inline-block; padding: 5px 20px; border-bottom: 4px solid #000; }
        
        .other-artists-box { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; border-top: 1px solid #eee; padding-top: 20px; margin-top: 10px; }
        .artist-chip { background: #f3f4f6; padding: 5px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 700; color: #1f2937; border: 1px solid #e5e7eb; }

        .action-container { width: 100%; max-width: 400px; margin: 20px auto; display: flex; flex-direction: column; gap: 12px; }
        .save-btn { background: var(--accent-l); color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 800; cursor: pointer; }
        .sns-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sns-btn { padding: 12px; border-radius: 12px; text-decoration: none; color: white; font-size: 0.7rem; font-weight: 800; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .x-btn { background: #111; }
        .ig-btn { background: linear-gradient(45deg, #f09433, #bc1888); }
        .retry-text { text-align: center; color: var(--text-dim); font-size: 0.7rem; margin-top: 20px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>MUSIC DNA</h1>
        <div id="loading-status">Loading Data...</div>
    </header>
    <div class="question-wrapper" id="q-list"></div>
    <button id="analyze-btn" class="analyze-btn" disabled onclick="showResult()">åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
</div>

<div id="result-overlay">
    <div id="capture-area">
        <div class="card-top">
            <div style="font-size: 0.5rem; letter-spacing: 3px; color: #71717a;">MUSIC DNA REPORT</div>
            <div style="font-size: 1rem; font-weight: 900; margin-top: 5px;">CERTIFIED LISTENER</div>
        </div>
        <div class="card-content">
            <div id="res-title" class="res-title">-</div>
            <p id="res-desc" class="res-desc">-</p>
            
            <div class="best-artist-display">
                <div class="match-section-title">ä¸€ç•ªåˆã†ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã¯ã“ã¡ã‚‰ï¼</div>
                <div id="best-match-name" class="best-name">Searching...</div>
            </div>

            <div class="other-section">
                <div class="match-section-title">ä»–ã¯ã“ã‚ŒãŒãŠã™ã™ã‚ï¼</div>
                <div id="other-match-list" class="other-artists-box"></div>
            </div>
        </div>
    </div>
    <div class="action-container">
        <button class="save-btn" onclick="saveAsImage()">ğŸ“¸ çµæœã‚’ç”»åƒã§ä¿å­˜ã™ã‚‹</button>
        <div class="sns-grid">
            <a id="share-x" href="#" target="_blank" class="sns-btn x-btn">Xã§ã‚·ã‚§ã‚¢</a>
            <a href="https://www.instagram.com/" target="_blank" class="sns-btn ig-btn">Instagram</a>
        </div>
        <div class="retry-text" onclick="location.reload()">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</div>
    </div>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRyt_I_8kDlfPnMSxsVSYBcytr3ur76vs7xmF30t01RFQUkAlULzF8P1oLlsFdLcyMZrQCMj3PAANV/pub?output=csv';
    
    // ï¼ˆquestions, titleMap ã¯å‰å›ã¨åŒã˜ã§ã™ï¼‰
    const questions = [
        { a: "çˆ†éŸ³ã®ãƒ­ãƒƒã‚¯ã§è§£æ”¾ã•ã‚ŒãŸã„", b: "ä¸€ç·’ã«æ²ˆã‚“ã§ãã‚Œã‚‹æ›²ã«æ•‘ã‚ã‚ŒãŸã„", catA: "energy", catB: "deep" },
        { a: "ãƒ©ã‚¤ãƒ–ã§ç››ã‚Šä¸ŠãŒã‚‹ãƒŠãƒ³ãƒãƒ¼", b: "ãŠæ´’è½ã§æ´—ç·´ã•ã‚ŒãŸãƒãƒ«ãªæ™‚é–“", catA: "energy", catB: "aesthetic" },
        { a: "æ­Œè©ã‚’å™›ã¿ç· ã‚æ·±ãè€ƒå¯Ÿã—ãŸã„", b: "ç©ºé–“ã‚’å½©ã‚‹éŸ¿ãã«é…”ã„ã—ã‚ŒãŸã„", catA: "deep", catB: "aesthetic" },
        { a: "è¤‡é›‘ãªæ§‹æˆã«è„³ãŒã‚¾ã‚¯ã‚¾ã‚¯ã™ã‚‹", b: "ç›´æ„Ÿçš„ãªãƒ‘ãƒ¯ãƒ¼ã«ä½“ãŒå‹•ã", catA: "skill", catB: "energy" },
        { a: "æ¥½å™¨å˜ä½“ã®å‡„ã•ã‚’è´ãè¾¼ã¿ãŸã„", b: "ãƒœãƒ¼ã‚«ãƒ«ã‚„å…¨ä½“ã®é›°å›²æ°—ãŒå¤§äº‹", catA: "skill", catB: "aesthetic" },
        { a: "å®Œç’§ãªã‚¤ãƒ³ãƒˆãƒ­ã‹ã‚‰å§‹ã¾ã‚ŠãŸã„", b: "ç‰©èªã®ä½™éŸ»ã«æ·±ãæµ¸ã‚ŠãŸã„", catA: "skill", catB: "deep" },
        { a: "æ­£ä½“ä¸æ˜ãªæ‰èƒ½ã‚’è¦‹ã¤ã‘ãŸã„", b: "åœ§å€’çš„ãªç†±é‡ã‚’æ”¾ã¤ã‚¹ã‚¿ãƒ¼ãŒå¥½ã", catA: "dig", catB: "energy" },
        { a: "ç„¡åã®ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ã‚ºã‚’æ˜ã‚ŠãŸã„", b: "æ´—ç·´ã•ã‚ŒãŸæœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æµ´ã³ãŸã„", catA: "dig", catB: "aesthetic" },
        { a: "å¸¸ã«æ–°ã—ã„åˆºæ¿€ã‚’æ˜ã‚Šç¶šã‘ãŸã„", b: "è·äººèŠ¸ã®ã‚ˆã†ãªæ¼”å¥ã‚’å ªèƒ½ã—ãŸã„", catA: "dig", catB: "skill" },
        { a: "é›¨ã®æ—¥ã‚„æ·±å¤œã«ä¸€äººã§æµ¸ã‚‹éŸ³æ¥½", b: "æ™´å¤©ã®ãƒ‰ãƒ©ã‚¤ãƒ–ã«èƒŒä¸­ã‚’æŠ¼ã™éŸ³æ¥½", catA: "deep", catB: "energy" },
        { a: "æ¥½å™¨ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã«æƒ¹ã‹ã‚Œã‚‹", b: "å­¤ç‹¬ã‚„è‘›è—¤ãŒä¼ã‚ã‚‹ç”Ÿã€…ã—ã„æ­Œ", catA: "skill", catB: "deep" },
        { a: "ãƒˆãƒ¼ã‚¿ãƒ«ãªç¾å­¦ãŒã‚ã‚‹äººãŒå¥½ã", b: "éŸ³æ¥½ãã®ã‚‚ã®ã®ç•°è³ªã•ãŒå¥½ã", catA: "aesthetic", catB: "dig" },
        { a: "çˆ†ç™ºçš„ãªå…ƒæ°—ã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ãŸã„", b: "å„ªé›…ã§å¿ƒåœ°ã‚ˆã„å®‰ã‚‰ããŒã»ã—ã„", catA: "energy", catB: "aesthetic" },
        { a: "å¿ƒã‚’æºã•ã¶ã‚‹ã®ã¯ã€Œé­‚ã®å«ã³ã€", b: "å¿ƒã‚’æºã•ã¶ã‚‹ã®ã¯ã€ŒéŸ³ã®æ§‹ç¯‰ç¾ã€", catA: "deep", catB: "skill" },
        { a: "ã€Œè‡ªåˆ†ã ã‘ãŒçŸ¥ã‚‹ã€ç‰¹åˆ¥æ„ŸãŒå¤§äº‹", b: "ã€Œã¿ã‚“ãªã§ç†±ããªã‚‹ã€ä¸€ä½“æ„ŸãŒå¤§äº‹", catA: "dig", catB: "energy" }
    ];

    const titleMap = {
        "energy_skill": ["è¶…çµ¶æŠ€å·§ã®ç†±ç‹‚çš„ãƒã‚¨ã‚¹ãƒˆãƒ­", "æ¿€ã—ã•ã®ä¸­ã«ã‚ã‚‹ç·»å¯†ãªæŠ€è¡“ã‚„æ§‹æˆã®å‡„ã•ã‚’è¦‹æŠœãè€³ã®æŒã¡ä¸»ã€‚"],
        "energy_dig": ["æœ€å‰ç·šã‚’ç„¼ãçˆ†éŸ³ãƒãƒ³ã‚¿ãƒ¼", "åˆºæ¿€ã¨ç†±ç‹‚ã‚’æ±‚ã‚ã¦ã€æœªçŸ¥ã®æ‰èƒ½ã‚’æ˜ã‚Šç¶šã‘ã‚‹é–‹æ‹“è€…ã€‚"],
        "energy_deep": ["é­‚ã‚’éœ‡ã‚ã›ã‚‹æƒ…ç†±ã®ä»£å¼è€…", "æ˜ã‚‹ã„æ›²ã®ä¸­ã«ã‚‚æ·±ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ€§ã‚’æ±‚ã‚ã€å…¨åŠ›ã§æ„Ÿæƒ…ç§»å…¥ã™ã‚‹ã€‚"],
        "energy_aesthetic": ["å…‰ã‚Šè¼ãã‚¹ãƒ†ãƒ¼ã‚¸ã®ç›®æ’ƒè€…", "æ´¾æ‰‹ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„æ´—ç·´ã•ã‚ŒãŸç¾å­¦ã‚’æ„›ã™ã‚‹ã€‚"],
        "deep_skill": ["æ·±æ·µã‚’è¨­è¨ˆã™ã‚‹éŸ³éŸ¿å“²å­¦è€…", "ç‰©èªæ€§ã‚’å¤§äº‹ã«ã—ã¤ã¤ã€ãã®è£ã«ã‚ã‚‹è¤‡é›‘ãªéŸ³ã®é‡ãªã‚Šã‚’åˆ†æã™ã‚‹ã€‚"],
        "deep_dig": ["ãƒãƒƒãƒˆã®æµ·åº•ã‚’æ¼‚ã†æ„Ÿæƒ…ã®è¦³æ¸¬è€…", "è‡ªåˆ†ã ã‘ã®å­¤ç‹¬ã«å¯„ã‚Šæ·»ã†ã€ã¾ã è¦‹ã¬æ­Œã‚’ãƒãƒƒãƒˆã®åº•ã§æ¢ã—ç¶šã‘ã‚‹ã€‚"],
        "deep_energy": ["é™å¯‚ã‚’åˆ‡ã‚Šè£‚ãå¿ƒã®é©å‘½å®¶", "å†…å´ã«å¼·ã„ç†±é‡ã‚’ç§˜ã‚ã¦ãŠã‚Šã€ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãªçˆ†éŸ³ã«æ•‘ã„ã‚’è¦‹å‡ºã™ã€‚"],
        "deep_aesthetic": ["æœˆå¤œã«æ²ˆã‚€ç¾å­¦ã®è©©äºº", "ç¾ã—ã„è¨€è‘‰é¸ã³ã¨ç¶ºéº—ãªæ—‹å¾‹ã ã‘ã«æµ¸ã‚Šã€è‡ªåˆ†ã ã‘ã®ä¸–ç•Œã‚’ä½œã‚‹ã€‚"],
        "aesthetic_skill": ["å®Œç’§ãªä½™ç™½ã‚’å‰µã‚‹éŸ³éŸ¿ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ", "æ´—ç·´ã•ã‚ŒãŸç©ºæ°—æ„Ÿã¨ã€ãã‚Œã‚’æ”¯ãˆã‚‹é«˜åº¦ãªæŠ€å·§ã‚’æ„›ã™ã‚‹ã€‚"],
        "aesthetic_dig": ["ãƒˆãƒ¬ãƒ³ãƒ‰ã®å¢ƒç•Œã‚’æ­©ãå¯©ç¾å®¶", "å¸¸ã«æœ€å…ˆç«¯ã®ã‚»ãƒ³ã‚¹ã‚’æŒã¡ã€ã‚¸ãƒ£ãƒ³ãƒ«ãƒ¬ã‚¹ã«ã€Œä»Šã‹ã£ã“ã„ã„éŸ³ã€ã‚’ã‚­ãƒ£ãƒƒãƒã™ã‚‹ã€‚"],
        "aesthetic_energy": ["é®®ã‚„ã‹ã«è¸Šã‚‹ã‚¢ãƒ¼ãƒãƒ³ãƒ»ãƒ€ãƒ³ã‚µãƒ¼", "æ´—ç·´ã•ã‚ŒãŸãƒ“ãƒ¼ãƒˆã‚’å¥½ã¿ã€éŸ³æ¥½ã§æ—¥å¸¸ã‚’é®®ã‚„ã‹ã«å½©ã‚‹ã€‚"],
        "aesthetic_deep": ["é»„æ˜ã«å¯„ã‚Šæ·»ã†ã‚¨ãƒ¢ãƒ»ãƒ‰ãƒªãƒ¼ãƒãƒ¼", "åˆ‡ãªã„æ­Œè©ã«å¼±ãã€éŸ³æ¥½ã‚’è´ãã“ã¨ã§ç‰©èªã®ä¸­ã«æ²¡å…¥ã—ãŸã„äººã€‚"],
        "skill_dig": ["æœªè¸ã®è­œé¢ã‚’è§£ãéŸ³ã®è§£æå®˜", "èª°ã‚‚çœŸä¼¼ã§ããªã„ç‹¬è‡ªã®æ¼”å¥æŠ€è¡“ã‚„ã€ç•°è³ªãªã‚µã‚¦ãƒ³ãƒ‰æ§‹æˆã«å¿«æ„Ÿã‚’è¦šãˆã‚‹ã€‚"],
        "skill_energy": ["ç²¾å¯†ã«ç‹‚ã†æƒ…ç†±ã®ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ", "ç†æ€§çš„ã§ã‚ã‚ŠãªãŒã‚‰ç†±ã„ã€‚å®Œç’§ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã•ã‚ŒãŸç‹‚æ°—ã‚’æ„›ã™ã‚‹ã€‚"]
    };

    let artistMaster = [];
    let answers = new Array(questions.length).fill(null);

    async function init() {
        try {
            const res = await fetch(SHEET_URL);
            const csvText = await res.text();
            const rows = csvText.split(/\r?\n/).slice(1);
            artistMaster = rows.map(row => {
                const cols = row.split(',');
                if (cols.length < 2) return null;
                const tags = cols[1].toLowerCase().replace(/[ï¼ã€‚ã€]/g, ',').split(/[,.]/).map(t => t.trim());
                return { name: cols[0].trim().replace(/^"|"$/g, ''), tags: tags };
            }).filter(a => a && a.name);
            document.getElementById('loading-status').innerText = `âœ… ${artistMaster.length} Artists Synced`;
        } catch(e) {
            document.getElementById('loading-status').innerText = `âŒ Sync Failed`;
        }
        render();
    }

    function render() {
        const list = document.getElementById('q-list');
        questions.forEach((q, i) => {
            const d = document.createElement('div');
            d.className = 'q-container';
            d.innerHTML = `<span class="q-header">Phase ${i+1}</span><div class="choice-group">
                <button class="choice-btn" onclick="sel(${i},'A',this)">${q.a}</button>
                <button class="choice-btn" onclick="sel(${i},'B',this)">${q.b}</button>
            </div>`;
            list.appendChild(d);
        });
    }

    function sel(i, t, b) {
        answers[i] = t;
        Array.from(b.parentElement.children).forEach(btn=>btn.classList.remove('active'));
        b.classList.add('active');
        if(!answers.includes(null)) document.getElementById('analyze-btn').disabled = false;
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function showResult() {
        let s = {energy:0, deep:0, aesthetic:0, skill:0, dig:0};
        answers.forEach((ans, i) => s[ans==='A'?questions[i].catA:questions[i].catB]++);
        const sorted = Object.entries(s).sort((a,b)=>b[1]-a[1]);
        const t1 = sorted[0][0], t2 = sorted[1][0];
        const res = titleMap[`${t1}_${t2}`] || titleMap[`${t2}_${t1}`] || ["éŸ³æ¥½ã®å†’é™ºå®¶", "æœªçŸ¥ã®éŸ³ã‚’æ±‚ã‚ã‚‹è€…ã€‚"];

        document.getElementById('res-title').innerText = res[0];
        document.getElementById('res-desc').innerText = res[1];

        // å€™è£œã®åˆ†é¡
        let score15 = []; let score10 = []; let score5 = [];

        artistMaster.forEach(a => {
            let pts = 0;
            if(a.tags.some(tag => tag.includes(t1))) pts += 10;
            if(a.tags.some(tag => tag.includes(t2))) pts += 5;
            if(pts === 15) score15.push(a);
            else if(pts === 10) score10.push(a);
            else if(pts === 5) score5.push(a);
        });

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å„ªå…ˆé †ä½é †ã«çµåˆ
        const pool = [
            ...shuffleArray(score15),
            ...shuffleArray(score10),
            ...shuffleArray(score5)
        ];

        // 1ç•ªç›®ã‚’ã€Œæœ€é«˜ã®ç›¸æ€§ã€ã¨ã—ã¦æŠ½å‡º
        const bestOne = pool.length > 0 ? pool[0] : null;
        // 2ç•ªç›®ä»¥é™ã®æœ€å¤§4ä»¶ã‚’ã€ŒãŠã™ã™ã‚ã€ã¨ã—ã¦æŠ½å‡º
        const others = pool.slice(1, 5);

        // è¡¨ç¤ºï¼šä¸€ç•ªåˆã†ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ
        const bestLabel = document.getElementById('best-match-name');
        if (bestOne) {
            bestLabel.innerText = bestOne.name;
        } else {
            bestLabel.innerText = "å”¯ä¸€ç„¡äºŒã®æ„Ÿæ€§";
        }

        // è¡¨ç¤ºï¼šä»–ã®ãŠã™ã™ã‚
        const listContainer = document.getElementById('other-match-list');
        if (others.length === 0) {
            listContainer.innerHTML = '<p style="font-size:0.7rem; color:#999;">ä»–ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
        } else {
            listContainer.innerHTML = others.map(a => `<div class="artist-chip">${a.name}</div>`).join('');
        }

        document.getElementById('result-overlay').style.display = 'block';
        window.scrollTo(0,0);
    }

    async function saveAsImage() {
        const area = document.getElementById('capture-area');
        const canvas = await html2canvas(area, { backgroundColor: '#000', scale: 2 });
        const link = document.createElement('a');
        link.download = 'MUSIC_DNA.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }

    init();
</script>
</body>
</html>
